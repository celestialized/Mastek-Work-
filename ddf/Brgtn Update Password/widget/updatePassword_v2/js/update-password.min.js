define(["knockout","pubsub","navigation","notifier","ccConstants","ccPasswordValidator","CCi18n"],function(e,t,n,r,i,s,o){"use strict";return{WIDGET_ID:"updatePassword",ignoreBlur:e.observable(!1),interceptedLink:e.observable(null),isUserProfileInvalid:e.observable(!1),isProfileLocaleNotInSupportedLocales:e.observable(),beforeAppear:function(e){var t=this;t.user().loggedIn()==0?n.doLogin(n.getPath(),t.links().home.route):t.user().isSessionExpiredDuringSave()?t.user().isSessionExpiredDuringSave(!1):(t.user().resetPassword(),t.user().isChangePassword(!0),t.showViewProfile(!0),r.clearError(t.WIDGET_ID),r.clearSuccess(t.WIDGET_ID))},onLoad:function(u){var a=this,f=e.observable(!1),l=e.observable(null),c=e.observable(!1);u.ErrorMsg=u.translate("updateErrorMsg"),u.passwordErrorMsg=u.translate("passwordUpdateErrorMsg"),u.showViewProfile=function(e){e&&u.user().getCurrentUser(!1)},u.passwordFieldFocused=function(e,t){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignorePasswordValidation(!0),this.user().isUserProfileEdited(!0),!0)},u.passwordFieldLostFocus=function(e,t){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignorePasswordValidation(!1),!0)},u.inputFieldFocused=function(e,t){return this.user().isUserProfileEdited(!0),!0},u.confirmPwdFieldFocused=function(e,t){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().isUserProfileEdited(!0),this.user().ignoreConfirmPasswordValidation(!0),!0)},u.confirmPwdFieldLostFocus=function(e,t){return this.ignoreBlur&&this.ignoreBlur()?!0:(this.user().ignoreConfirmPasswordValidation(!1),!0)},u.handleMouseUp=function(){return this.ignoreBlur(!1),this.user().ignoreConfirmPasswordValidation(!1),!0},u.handleMouseDown=function(){return this.ignoreBlur(!0),this.user().ignoreConfirmPasswordValidation(!0),!0},u.hideModal=function(){if(f()||u.user().isSearchInitiatedWithUnsavedChanges())$("#CC-customerProfile-modal-2").modal("hide"),$("body").removeClass("modal-open"),$(".modal-backdrop").remove()},u.showModal=function(){$("#CC-customerProfile-modal-2").modal("show"),f(!0)},u.handleCancelUpdateForUpdatePassword=function(){u.showViewProfile(!0),u.user().resetPassword(),r.clearError(u.WIDGET_ID),r.clearSuccess(u.WIDGET_ID),u.hideModal(),u.user().isUserProfileEdited(!1)},u.handleModalCancelUpdateDiscard=function(){u.handleCancelUpdateForUpdatePassword(),u.user().isSearchInitiatedWithUnsavedChanges()?(u.hideModal(),u.user().isSearchInitiatedWithUnsavedChanges(!1),u.user().isUserProfileEdited(!1)):(u.user().isUserProfileEdited(!1),u.navigateAway())},u.handleUpdateProfileForUpdatePassword=function(){var e={},n=!1,r=!1,i=!1;u.user().isPasswordValid()?i=!0:n=!0,u.user().isPasswordModified()&&(r=!0);if(!r){$.Topic(t.topicNames.USER_PROFILE_UPDATE_NOCHANGE).publish();return}if(n){$.Topic(t.topicNames.USER_PROFILE_UPDATE_INVALID).publish();return}i&&u.user().handleUpdatePassword(e),u.user().invokeUpdateProfile(e)},u.handleModalUpdateProfile=function(){c(!0);if(u.user().isSearchInitiatedWithUnsavedChanges()){u.handleUpdateProfileForUpdatePassword(),u.hideModal(),u.user().isSearchInitiatedWithUnsavedChanges(!1);return}l!="CC-loginHeader-myAccount"&&u.user().delaySuccessNotification(!0),u.handleUpdateProfileForUpdatePassword()},$.Topic(t.topicNames.USER_PROFILE_UPDATE_NOCHANGE).subscribe(function(){u.showViewProfile(!1),u.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_SESSION_RESET).subscribe(function(){u.showViewProfile(!1),u.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_INVALID).subscribe(function(){r.sendError(u.WIDGET_ID,u.ErrorMsg,!0),c()&&(u.isUserProfileInvalid(!0),c(!1)),u.user().delaySuccessNotification(!1),u.hideModal()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_SUCCESSFUL).subscribe(function(){u.showViewProfile(!0),r.clearError(u.WIDGET_ID),r.clearSuccess(u.WIDGET_ID),u.user().delaySuccessNotification()||r.sendSuccess(u.WIDGET_ID,u.translate("updateSuccessMsg"),!0),u.hideModal(),u.user().isUserProfileEdited(!1),c()&&(c(!1),u.navigateAway()),$.Topic(t.topicNames.DISCARD_ADDRESS_CHANGES).publish()}),$.Topic(t.topicNames.USER_PROFILE_UPDATE_FAILURE).subscribe(function(e){c()&&(u.isUserProfileInvalid(!0),c(!1)),u.user().delaySuccessNotification(!1),u.hideModal();if(e.status==i.HTTP_UNAUTHORIZED_ERROR)u.user().isSessionExpiredDuringSave(!0),n.doLogin(n.getPath());else{var a=u.passwordErrorMsg;r.clearError(u.WIDGET_ID),r.clearSuccess(u.WIDGET_ID);if(e.errorCode==i.USER_PROFILE_OLD_PASSWORD_INCORRECT)$("#CC-customerProfile-soldPassword-phone-error-1").css("display","block"),$("#CC-customerProfile-soldPassword-phone-error-1").text(e.message),$("#CC-customerProfile-soldPassword-phone").addClass("invalid"),$("#CC-customerProfile-spassword1-error-1").css("display","block"),$("#CC-customerProfile-spassword1-error-1").text(e.message),$("#CC-customerProfile-soldPassword-1").addClass("invalid");else if(e.errorCode==i.USER_PROFILE_PASSWORD_POLICIES_ERROR){$("#CC-customerProfile-spassword-error-1").css("display","block"),$("#CC-customerProfile-spassword-error-1").text(o.t("ns.common:resources.passwordPoliciesErrorText")),$("#CC-customerProfile-spassword-1").addClass("invalid"),$("#CC-customerProfile-spassword-embeddedAssistance-1").css("display","block");var f=s.getAllEmbeddedAssistance(u.passwordPolicies(),!0);$("#CC-customerProfile-spassword-embeddedAssistance-1").text(f)}else e.errorCode===i.USER_PROFILE_INTERNAL_ERROR?(a=e.message,u.user().getCurrentUser(!1),u.reloadShipping()):a=e.message;r.sendError(u.WIDGET_ID,a,!0),u.hideModal()}$.Topic(t.topicNames.DISCARD_ADDRESS_CHANGES).publish()}),$.Topic(t.topicNames.UPDATE_USER_LOCALE_NOT_SUPPORTED_ERROR).subscribe(function(){u.isProfileLocaleNotInSupportedLocales(!0)}),u.navigateAway=function(){if(l==="CC-header-checkout"||l==="CC-loginHeader-logout"||l==="CC-customerAccount-view-orders"||l==="CC-header-language-link"||l.indexOf("CC-header-languagePicker")!=-1){u.removeEventHandlersForAnchorClick(),u.showViewProfile(!1);var e=$("#"+l).get()[0];e.click()}else if(l==="CC-loginHeader-myAccount"){var e=$("#"+l).get()[0];e.click()}else n.isPathEqualTo(u.interceptedLink)||(n.goTo(u.interceptedLink),u.removeEventHandlersForAnchorClick())};var h=function(e,t){var n=t&&t.usingCCLink;u.isProfileLocaleNotInSupportedLocales(!1);if(u.user().loggedIn()){l=this.id,u.interceptedLink=e.currentTarget.pathname;if(u.user().isUserProfileEdited())return u.showModal(),n&&(t.preventDefault=!0),!1;u.showViewProfile(!1)}},p=function(e){u.isProfileLocaleNotInSupportedLocales(!1)};u.addEventHandlersForAnchorClick=function(){$("body").on("click.cc.unsaved","a",h),$("body").on("mouseleave",p)},u.removeEventHandlersForAnchorClick=function(){$("body").off("click.cc.unsaved","a",h)}}}})